<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Track Bus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
    #etaBox {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 1000;
      font-family: Arial, sans-serif;
    }
  </style>
</head>
<body>
  <div id="etaBox">ETA: Calculating...</div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script type="module">
    import { db } from './config.js';
    import { ref, onValue } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    const mapboxToken = 'pk.eyJ1Ijoic3VzbWl0YWdvc2gwMDEiLCJhIjoiY21kdWs4dXN3MWRkMDJpc2EyODhwZGt5ZiJ9.TWuBu6Qq4s-x6XMXY-4QTA';

    const map = L.map('map').setView([24.904, 91.865], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    let driverMarker, userMarker, routeLine;

    const urlParams = new URLSearchParams(window.location.search);
    const busId = urlParams.get("busId") || "bus1";
    const userLat = parseFloat(urlParams.get("userLat"));
    const userLng = parseFloat(urlParams.get("userLng"));
    const userLatLng = [userLat, userLng];

    userMarker = L.marker(userLatLng, {
      title: "You",
      icon: L.icon({
        iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue.png',
        iconSize: [32, 32]
      })
    }).addTo(map);
    map.setView(userLatLng, 13);

    const busRef = ref(db, `buses/${busId}`);
    let currentDriverLatLng = null;

    onValue(busRef, (snapshot) => {
      const data = snapshot.val();
      if (data && data.latitude && data.longitude) {
        currentDriverLatLng = [data.latitude, data.longitude];

        if (driverMarker) {
          driverMarker.setLatLng(currentDriverLatLng);
        } else {
          driverMarker = L.marker(currentDriverLatLng, {
            title: "Driver",
            icon: L.icon({
              iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red.png',
              iconSize: [32, 32]
            })
          }).addTo(map);
        }

        drawRoute(currentDriverLatLng, userLatLng);
      }
    });

    async function drawRoute(start, end) {
      const url = `https://api.mapbox.com/directions/v5/mapbox/driving-traffic/${start[1]},${start[0]};${end[1]},${end[0]}?geometries=geojson&overview=full&access_token=${mapboxToken}`;

      try {
        const res = await fetch(url);
        const data = await res.json();

        if (!data.routes || data.routes.length === 0) {
          throw new Error("No route found.");
        }

        const route = data.routes[0];
        const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
        const duration = route.duration; // in seconds
        const distance = route.distance; // in meters

        const etaMinutes = Math.ceil(duration / 60);
        const distanceKm = (distance / 1000).toFixed(2);

        if (routeLine) map.removeLayer(routeLine);
        routeLine = L.polyline(coords, { color: 'blue', weight: 4 }).addTo(map);
        map.fitBounds(routeLine.getBounds());

        document.getElementById("etaBox").innerText = `ETA: ${etaMinutes} min, Distance: ${distanceKm} km`;
      } catch (err) {
        console.error("Mapbox route error:", err);
        document.getElementById("etaBox").innerText = "ETA: Unable to calculate.";
      }
    }

    // Optional: re-route every 10 seconds
    setInterval(() => {
      if (currentDriverLatLng) {
        drawRoute(currentDriverLatLng, userLatLng);
      }
    }, 10000);
  </script>
</body>
</html>
